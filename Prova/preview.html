<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuzione Codici Voucher</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-hover: #222632;
            --border: #2a2e3b;
            --text: #e8e9ed;
            --text-muted: #8b8fa3;
            --accent: #6c63ff;
            --accent-glow: rgba(108, 99, 255, 0.25);
            --accent-soft: rgba(108, 99, 255, 0.1);
            --success: #34d399;
            --success-bg: rgba(52, 211, 153, 0.08);
            --error: #f87171;
            --error-bg: rgba(248, 113, 113, 0.08);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -40%; left: -20%; width: 80%; height: 80%;
            background: radial-gradient(ellipse, rgba(108, 99, 255, 0.06) 0%, transparent 70%);
            pointer-events: none;
        }
        body::after {
            content: '';
            position: fixed;
            bottom: -30%; right: -10%; width: 60%; height: 60%;
            background: radial-gradient(ellipse, rgba(52, 211, 153, 0.04) 0%, transparent 70%);
            pointer-events: none;
        }

        .container { width: 100%; max-width: 480px; position: relative; z-index: 1; }

        .header { text-align: center; margin-bottom: 40px; }
        .header .badge {
            display: inline-block; font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
            text-transform: uppercase; color: var(--accent); background: var(--accent-soft);
            padding: 6px 14px; border-radius: 20px; margin-bottom: 16px;
        }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; line-height: 1.2; margin-bottom: 8px; }
        .header p { color: var(--text-muted); font-size: 14px; }

        .card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 32px; animation: fadeUp 0.5s ease-out;
        }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        .field { margin-bottom: 24px; }
        .field label {
            display: block; font-size: 12px; font-weight: 700; letter-spacing: 0.5px;
            text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px;
        }

        .toggle-group { display: flex; gap: 10px; }
        .toggle-btn {
            flex: 1; padding: 14px; border: 1px solid var(--border); border-radius: var(--radius);
            background: transparent; color: var(--text-muted); font-family: 'DM Sans', sans-serif;
            font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .toggle-btn:hover { background: var(--surface-hover); border-color: #3a3f50; }
        .toggle-btn.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
        .toggle-btn .label-main { display: block; font-weight: 700; font-size: 15px; color: inherit; }
        .toggle-btn .label-sub { display: block; font-size: 11px; margin-top: 2px; opacity: 0.7; }
        .toggle-btn.active .label-main { color: #a5a0ff; }

        .input {
            width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: var(--radius);
            background: transparent; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s; outline: none;
        }
        .input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .input::placeholder { color: #4a4e5c; }
        .input-wrap { position: relative; }
        .input-wrap .input { padding-right: 44px; }
        .input-wrap .unit { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 700; font-size: 15px; pointer-events: none; }

        .submit-btn {
            width: 100%; padding: 16px; border: none; border-radius: var(--radius); background: var(--accent);
            color: #fff; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.2s, opacity 0.2s; margin-top: 8px;
        }
        .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px var(--accent-glow); }
        .submit-btn:active { transform: translateY(0); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Results ────────────────────────── */
        .results { margin-top: 24px; animation: fadeUp 0.4s ease-out; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .results-header h2 { font-family: 'Playfair Display', serif; font-size: 18px; }
        .results-header .totale { font-size: 13px; color: var(--success); font-weight: 700; background: var(--success-bg); padding: 4px 12px; border-radius: 20px; }

        /* Single code box */
        .code-box-wrap { position: relative; }
        .code-box {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            font-family: 'DM Mono', 'DM Sans', monospace;
            font-size: 14px;
            line-height: 2;
            color: var(--text);
            white-space: pre;
            user-select: all;
            letter-spacing: 0.3px;
        }
        .code-box .eur { color: var(--accent); font-weight: 700; }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex; align-items: center; gap: 5px; padding: 6px 14px;
            border: 1px solid var(--border); border-radius: 8px; background: var(--surface);
            color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 12px;
            font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .copy-btn:hover { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
        .copy-btn.copied { background: var(--success-bg); border-color: var(--success); color: var(--success); }
        .copy-btn svg { width: 14px; height: 14px; }

        .summary {
            margin-top: 16px; padding: 14px 16px; background: var(--success-bg);
            border: 1px solid rgba(52, 211, 153, 0.15); border-radius: 10px;
            font-size: 13px; color: var(--success); text-align: center; font-weight: 500;
        }
        .error-msg {
            margin-top: 24px; padding: 14px 16px; background: var(--error-bg);
            border: 1px solid rgba(248, 113, 113, 0.15); border-radius: 10px;
            font-size: 13px; color: var(--error); text-align: center; font-weight: 500; animation: fadeUp 0.3s ease-out;
        }
        .reset-link { display: block; text-align: center; margin-top: 16px; color: var(--text-muted); font-size: 13px; cursor: pointer; text-decoration: none; transition: color 0.2s; }
        .reset-link:hover { color: var(--text); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="badge">Sistema Distribuzione</div>
            <h1>Codici Voucher</h1>
            <p>Seleziona tipo, edizione e importo per assegnare i codici</p>
        </div>

        <div class="card">
            <form id="voucherForm">
                <div class="field">
                    <label>Tipo Voucher</label>
                    <div class="toggle-group">
                        <button type="button" class="toggle-btn active" data-value="CDD" onclick="selectTipo(this)">
                            <span class="label-main">CDD</span>
                            <span class="label-sub">Carta del Docente</span>
                        </button>
                        <button type="button" class="toggle-btn" data-value="YM" onclick="selectTipo(this)">
                            <span class="label-main">YM</span>
                            <span class="label-sub">Giovani Merito</span>
                        </button>
                    </div>
                </div>

                <div class="field">
                    <label>Edizione</label>
                    <div class="toggle-group">
                        <button type="button" class="toggle-btn active" data-value="2024" onclick="selectEdizione(this)">
                            <span class="label-main">2024</span>
                        </button>
                        <button type="button" class="toggle-btn" data-value="2025" onclick="selectEdizione(this)">
                            <span class="label-main">2025</span>
                        </button>
                    </div>
                </div>

                <div class="field">
                    <label>Importo Richiesto</label>
                    <div class="input-wrap">
                        <input type="number" class="input" id="importo" placeholder="0.00" step="0.01" min="0.01" required>
                        <span class="unit">€</span>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">Assegna Codici</button>
            </form>

            <div id="output"></div>
        </div>
    </div>

    <script>
        const ICON_COPY = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
        const ICON_CHECK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;

        let tipo = 'CDD';
        let edizione = '2024';

        function selectTipo(btn) {
            document.querySelectorAll('.field:nth-child(1) .toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            tipo = btn.dataset.value;
        }
        function selectEdizione(btn) {
            document.querySelectorAll('.field:nth-child(2) .toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            edizione = btn.dataset.value;
        }

        function copyAll(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.classList.add('copied');
                btn.innerHTML = `${ICON_CHECK} Copiato`;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `${ICON_COPY} Copia`;
                }, 1500);
            });
        }

        function buildResultsHTML(codici, totale, importo) {
            // Plain text for clipboard (one per line)
            const plainLines = codici.map(c => `${c.codice_id} EUR ${c.importo.toFixed(2)}`).join('\n');

            // HTML display with colored EUR
            const htmlLines = codici.map(c =>
                `${c.codice_id} <span class="eur">EUR ${c.importo.toFixed(2)}</span>`
            ).join('\n');

            const diff = totale - importo;
            const diffText = diff > 0 ? ` (eccedenza: +${diff.toFixed(2)} €)` : '';

            // Escape for onclick
            const escaped = plainLines.replace(/'/g, "\\'").replace(/\n/g, "\\n");

            return `
                <div class="results">
                    <div class="results-header">
                        <h2>Codici Assegnati</h2>
                        <span class="totale">${totale.toFixed(2)} €</span>
                    </div>
                    <div class="code-box-wrap">
                        <div class="code-box">${htmlLines}</div>
                        <button class="copy-btn" onclick="copyAll('${escaped}', this)">${ICON_COPY} Copia</button>
                    </div>
                    <div class="summary">
                        ${codici.length} codici assegnati per un totale di ${totale.toFixed(2)} €${diffText}
                    </div>
                    <a class="reset-link" onclick="resetForm()">← Nuova assegnazione</a>
                </div>`;
        }

        // Demo mode
        document.getElementById('voucherForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const importo = parseFloat(document.getElementById('importo').value);
            if (!importo || importo <= 0) return;

            const btn = document.getElementById('submitBtn');
            const output = document.getElementById('output');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Elaborazione...';
            output.innerHTML = '';

            await new Promise(r => setTimeout(r, 800));

            const demoCodici = [];
            let remaining = importo;
            let id = Math.floor(Math.random() * 900) + 100;
            const values = [100, 50, 25, 15, 10];
            for (const v of values) {
                if (remaining <= 0) break;
                if (v <= remaining) { demoCodici.push({ codice_id: id++, tipo, importo: v, edizione }); remaining -= v; }
            }
            if (remaining > 0 && remaining < values[values.length - 1])
                demoCodici.push({ codice_id: id++, tipo, importo: values[values.length - 1], edizione });

            const totale = demoCodici.reduce((s, c) => s + c.importo, 0);
            output.innerHTML = buildResultsHTML(demoCodici, totale, importo);
            btn.disabled = false;
            btn.innerHTML = 'Assegna Codici';
        });

        function resetForm() {
            document.getElementById('importo').value = '';
            document.getElementById('output').innerHTML = '';
            document.getElementById('importo').focus();
        }
    </script>
</body>
</html>
